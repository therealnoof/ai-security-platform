---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const digests = await getCollection('digests', ({ data }) => !data.draft);
const sortedDigests = digests.sort((a, b) =>
  new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

function getMondayLabel(year: number, weekNumber: number): string {
  const jan4 = new Date(year, 0, 4);
  const dayOfWeek = jan4.getDay() || 7;
  const mondayWeek1 = new Date(jan4);
  mondayWeek1.setDate(jan4.getDate() - dayOfWeek + 1);
  const monday = new Date(mondayWeek1);
  monday.setDate(mondayWeek1.getDate() + (weekNumber - 1) * 7);
  return monday.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
}
---

<BaseLayout title="Last Week in AI" description="Weekly curated summaries of AI security news and research.">
  <section class="page-header">
    <div class="page-header-bg">
      <img src="/images/lastweekinai.jpg" alt="" role="presentation" width="1920" height="1080" />
    </div>
    <div class="container">
      <h1>Last Week in AI</h1>
      <p>Curated summaries of the most important AI security developments, delivered every Friday.</p>
    </div>
  </section>

  <section class="digests-section">
    <div class="container">
      {sortedDigests.length === 0 ? (
        <div class="empty-state">
          <span class="empty-icon">ðŸ“Š</span>
          <h2>Coming Soon</h2>
          <p>Weekly digests are being prepared. The first issue will be published soon.</p>
        </div>
      ) : (
        <div class="digests-grid">
          {sortedDigests.map(digest => (
            <a href={`/digests/${digest.id.replace(/\.md$/, '')}`} class="digest-card card">
              {digest.data.image && (
                <div class="digest-card-image">
                  <img src={digest.data.image} alt="" role="presentation" width="600" height="315" />
                </div>
              )}
              <div class="digest-meta">
                <span class="digest-week">Week of {getMondayLabel(digest.data.year, digest.data.weekNumber)}</span>
                <span class="digest-year">{digest.data.year}</span>
              </div>
              <h3>{digest.data.title}</h3>
              <p>{digest.data.description}</p>
              {digest.data.highlights.length > 0 && (
                <ul class="digest-highlights">
                  {digest.data.highlights.slice(0, 3).map(highlight => (
                    <li>{highlight}</li>
                  ))}
                </ul>
              )}
              <span class="read-more">Read digest â†’</span>
            </a>
          ))}
        </div>
      )}
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    position: relative;
    padding: 6rem 0;
    text-align: center;
    overflow: hidden;
  }

  .page-header-bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .page-header-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .page-header-bg::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(10, 14, 26, 0.75);
  }

  .page-header .container {
    position: relative;
    z-index: 1;
  }

  .page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
  }

  .digests-section {
    padding: 3rem 0;
  }

  .digests-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .digest-card {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .digest-card-image {
    margin: -1.5rem -1.5rem 1rem;
    border-radius: 12px 12px 0 0;
    overflow: hidden;
    line-height: 0;
  }

  .digest-card-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .digest-card:hover h3 {
    color: var(--color-accent-cyan);
  }

  .digest-meta {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .digest-week {
    padding: 0.25rem 0.5rem;
    background: rgba(34, 211, 238, 0.1);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-accent-cyan);
  }

  .digest-year {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  .digest-card h3 {
    font-size: 1.15rem;
    margin-bottom: 0.5rem;
    transition: color 0.2s ease;
  }

  .digest-card p {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .digest-highlights {
    list-style: none;
    margin-bottom: 1rem;
  }

  .digest-highlights li {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    padding-left: 1rem;
    position: relative;
    margin-bottom: 0.25rem;
  }

  .digest-highlights li::before {
    content: 'â€¢';
    position: absolute;
    left: 0;
    color: var(--color-accent-cyan);
  }

  .read-more {
    font-size: 0.85rem;
    color: var(--color-accent-cyan);
    font-weight: 500;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
  }

  .empty-state h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--color-text-secondary);
  }

  @media (max-width: 768px) {
    .page-header {
      padding: 4rem 0;
    }

    .page-header h1 {
      font-size: 2rem;
    }

    .digests-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
