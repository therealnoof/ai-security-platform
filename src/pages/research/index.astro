---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Card from '../../components/Card.astro';
import { getCollection, getEntry } from 'astro:content';

const posts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = posts.sort((a, b) =>
  new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

const postsWithAuthors = await Promise.all(
  sortedPosts.map(async (post) => {
    const authorEntry = post.data.author ? await getEntry('authors', post.data.author) : null;
    return {
      post,
      authorName: authorEntry?.data.name,
      authorAvatar: authorEntry?.data.avatar,
    };
  })
);
---

<BaseLayout title="Research" description="AI security research, analysis, and threat intelligence.">
  <section class="page-header">
    <div class="page-header-bg">
      <img src="/images/research.jpg" alt="" role="presentation" width="1920" height="1080" />
    </div>
    <div class="container">
      <h1>Research</h1>
      <p>In-depth analysis of AI security vulnerabilities, attack vectors, and defense strategies.</p>
    </div>
  </section>

  <section class="posts-section">
    <div class="container">
      {postsWithAuthors.length === 0 ? (
        <div class="empty-state">
          <span class="empty-icon">üìù</span>
          <h2>Coming Soon</h2>
          <p>Research articles are being prepared. Check back soon for in-depth AI security analysis.</p>
        </div>
      ) : (
        <div class="posts-grid">
          {postsWithAuthors.map(({ post, authorName, authorAvatar }) => (
            <Card
              title={post.data.title}
              description={post.data.description}
              href={`/research/${post.id.replace(/\.md$/, '')}`}
              date={post.data.pubDate.toISOString()}
              tags={post.data.tags}
              featured={post.data.featured}
              image={post.data.image}
              author={authorName}
              authorAvatar={authorAvatar}
            />
          ))}
        </div>
      )}
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    position: relative;
    padding: 6rem 0;
    text-align: center;
    overflow: hidden;
  }

  .page-header-bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .page-header-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .page-header-bg::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(10, 14, 26, 0.75);
  }

  .page-header .container {
    position: relative;
    z-index: 1;
  }

  .page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
  }

  .posts-section {
    padding: 3rem 0;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
  }

  .empty-state h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--color-text-secondary);
  }

  @media (max-width: 768px) {
    .page-header {
      padding: 4rem 0;
    }

    .page-header h1 {
      font-size: 2rem;
    }

    .posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
